# Tests

This package provides test coverage for @bufbuild/protobuf with Jest. 

We also generate code for many of the unit test proto files that are part of 
github.com/protocolbuffers/protobuf. They cover many edge cases for both code 
generation and serialization.

Many test cases are run several times, once with the generated TypeScript code, 
once with the generated JavaScript code, and once with types created at runtime 
from a file descriptor set.

To cover the code path for our string-based fallback for 64-bit integers, the
entire suite should be run with the environment variable 
`BUF_BIGINT_DISABLE=1`, which disables our BigInt feature detection. 

## TypeScript

Our TypeScript compatibility tests are run by the Make target `test-ts-compat`.
Running this target will iterate over all versions specified in a sorted, 
pre-configured list in the Makefile and use that version to compile protobuf-es.  
If any compilation error is encountered, the process will exit immediately.

The versions list is compiled of:

- the earliest TypeScript version we support (4.1.2).
- the earliest version we support with `skipLibChecks` set to `false`.
- the current release candidate
- the latest patch release of all minor versions in between

### Adding a new version

The following instructions will illustrate how to add a new version to the 
compatibility tests.  

For example, assuming we are adding version `4.5.3`.  

1.  Run the following command from the project root.  This will install the 
specified version of TypeScript as a package alias to `protobuf-test`.  Note 
that the version before the `@` sign is the version number with all decimals 
replaced with underscores:

    `npm i -w packages/protobuf-test ts4_5_3@npm:typescript@4.5.3`

2.  Change directories to the TypeScript test directory:

    `cd packages/protobuf-test/typescript`

3.  Generate a `tsconfig.json` file by running:

    `../../../node_modules/ts4_5_3/bin/tsc --init`

4.  Once generated, rename the file:

    `mv tsconfig.json tsconfig.4_5_3.json`

5.  Remove any extraneous comments from the file that were autogenerated.

6.  If you are adding a version after `4.5.3`, make sure to change 
`skipLibCheck` to `false` in the tsconfig `compilerOptions` to test full 
regressions on newer versions.

7.  Add the following `include` property before the `compilerOptions`:

    `"include": ["../src/gen/js/extra/*.js", "../src/gen/ts/extra/*.ts"],`

8.  Finally, add the version to the `TS_VERSIONS` variable in the Makefile.  
Make sure to add it in numerical order.

